#addin "Cake.FileHelpers"
#addin "Cake.Xamarin"

//////////////////////////////////////////////////////////////////////
// ARGUMENTS
//////////////////////////////////////////////////////////////////////

var target = Argument("target", "Default");
var configuration = Argument("configuration", "Release");

//////////////////////////////////////////////////////////////////////
// FILES & DIRECTORIES
//////////////////////////////////////////////////////////////////////

var solutionFile = File("../TodoPCL.sln");
var androidProject = File("../Todo.Android/Todo.Android.csproj");
var androidBin = Directory("../Todo.Android/bin") + Directory(configuration);
var iOSProject = File("../Todo.iOS/ToDo.iOS.csproj");
var iOSBin = Directory("../Todo.iOS/bin/iPhone") + Directory(configuration);

//////////////////////////////////////////////////////////////////////
// PREPARATION
//////////////////////////////////////////////////////////////////////

Task("Clean")
    .Does(() =>
{
    CleanDirectory(androidBin);
    CleanDirectory(iOSBin);
});

Task("Restore-NuGet")
    .IsDependentOn("Clean")
    .Does(() =>
{
    NuGetRestore(solutionFile);
});

//////////////////////////////////////////////////////////////////////
// ANDROID
//////////////////////////////////////////////////////////////////////

Task("Build Android")
    .IsDependentOn("Restore-NuGet")
    .Does(() =>
{
 	MSBuild(androidProject, settings =>
        settings.SetConfiguration(configuration).WithTarget("SignAndroidPackage"));
});

//////////////////////////////////////////////////////////////////////
// IOS
//////////////////////////////////////////////////////////////////////

Task("Build iOS")
    .WithCriteria(IsRunningOnUnix())
    .IsDependentOn("Build Android")
    .Does(() =>
{
    MSBuild (iOSProject, settings => 
	    settings.SetConfiguration(configuration)
    		.WithProperty("Platform", "iPhone")
    		.WithProperty("OutputPath", $"bin/iPhone/{configuration}/"));
});

//////////////////////////////////////////////////////////////////////
// TESTS
//////////////////////////////////////////////////////////////////////

Task("Build tests")
    .IsDependentOn("Build iOS")
    .Does(() =>
{
});

Task("Run unit tests")
    .IsDependentOn("Build tests")
    .Does(() =>
{
});

Task("Run UI tests")
    .IsDependentOn("Run unit tests")
    .Does(() =>
{
});

//////////////////////////////////////////////////////////////////////
// TASK TARGETS
//////////////////////////////////////////////////////////////////////

Task("Default")
    .IsDependentOn("Run UI tests");

//////////////////////////////////////////////////////////////////////
// EXECUTION
//////////////////////////////////////////////////////////////////////

RunTarget(target);